<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAK PRO - Database Kepegawaian</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #818cf8; 
            --danger: #f87171; 
            --success: #4ade80; 
            --bg: #0f172a; 
            --card-bg: rgba(30, 41, 59, 0.85); /* Semi-transparan agar background terlihat */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }

        body { 
            /* BACKGROUND IMAGE DARI DRIVE */
            background: linear-gradient(rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.8)), 
                        url('https://lh3.googleusercontent.com/d/1Gxy3PVLDs3eExxxrj5GG27YZUVufFceL');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            margin: 0; padding: 20px; color: var(--text-main); min-height: 100vh;
        }

        .container { max-width: 1200px; margin: auto; }
        
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 25px; border-bottom: 1px solid var(--border); 
            padding-bottom: 15px; background: rgba(15, 23, 42, 0.4);
            padding: 20px; border-radius: 16px;
        }

        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo-img { width: 50px; height: auto; } /* UKURAN LOGO */

        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { 
            background: var(--card-bg); padding: 20px; border-radius: 16px; 
            border: 1px solid var(--border); backdrop-filter: blur(10px);
        }
        .stat-card small { color: var(--text-muted); font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .stat-card div { font-size: 26px; font-weight: 700; color: var(--primary); margin-top: 5px; }

        .search-box { 
            background: var(--card-bg); padding: 15px; border-radius: 12px; 
            border: 1px solid var(--border); margin-bottom: 20px; backdrop-filter: blur(10px);
        }
        .search-box input { 
            width: 100%; padding: 12px; background: #0f172a;
            border: 1px solid var(--border); border-radius: 8px; 
            font-size: 14px; color: white; outline: none; 
        }

        .table-container { 
            background: var(--card-bg); border-radius: 16px; 
            overflow: hidden; border: 1px solid var(--border); overflow-x: auto;
            backdrop-filter: blur(10px);
        }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: rgba(30, 41, 59, 0.5); padding: 15px; text-align: left; font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tbody tr:hover { background-color: rgba(255, 255, 255, 0.05) !important; transition: 0.2s; }

        .badge { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; display: inline-block; }
        .active { background: #064e3b; color: #4ade80; }
        .expired { background: #7f1d1d; color: #f87171; }
        .none { background: #334155; color: var(--text-muted); }

        .btn-view { 
            color: white; font-weight: 700; cursor: pointer; border: none; 
            padding: 8px 14px; border-radius: 8px; background: var(--primary); transition: 0.3s;
        }

        /* MODAL SYSTEM */
        .modal { 
            display:none; position:fixed; inset:0; background:rgba(0, 0, 0, 0.85); 
            backdrop-filter:blur(10px); z-index:100; justify-content:center; align-items:center; padding:20px; 
        }
        .modal-content { 
            background: #1e293b; padding:30px; border-radius:24px; 
            width:100%; max-width:450px; border: 1px solid var(--border); color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        /* PASSWORD INPUT STYLING */
        .pass-input {
            width: 100%; padding: 15px; margin: 15px 0; border-radius: 10px;
            border: 1px solid var(--primary); background: #0f172a; color: white;
            font-size: 18px; text-align: center; letter-spacing: 5px;
        }

        .doc-link { 
            display:flex; justify-content:space-between; align-items:center; 
            padding:12px; background: #0f172a; border:1px solid var(--border); 
            border-radius:10px; text-decoration:none; color: var(--text-main); 
            margin-bottom:10px; font-weight:600; font-size:13px; transition: 0.3s;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo-section">
            <img src="https://lh3.googleusercontent.com/d/14HiGLsqfgL6SeO66kOw6DtDkuQyYye7a" alt="Logo" class="logo-img">
            <h1>Arsip Kepegawaian Digital</h1>
        </div>
        <div id="status" style="font-size: 12px; color: var(--text-muted);">üîÑ Memproses Koneksi...</div>
    </div>

    <div class="stats-bar">
        <div class="stat-card"><small>Total SDM</small><div id="statTotal">0</div></div>
        <div class="stat-card"><small>STR Aktif</small><div id="statStr" style="color:var(--success)">0</div></div>
        <div class="stat-card"><small>SIP Aktif</small><div id="statSip" style="color:var(--success)">0</div></div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Cari Nama Pegawai atau NIP..." onkeyup="filterData()">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nama Pegawai</th>
                    <th>Unit & Jabatan</th>
                    <th>Status STR</th>
                    <th>Status SIP</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="5" style="text-align:center; padding:50px;">Menghubungkan ke database...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="modal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content" id="modalContent"></div>
</div>

<div id="passModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3>Verifikasi Admin</h3>
        <p style="color: var(--text-muted); font-size: 13px;">Silakan masukkan sandi untuk membuka dokumen.</p>
        <input type="password" id="adminPassInput" class="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="submitPassword()" style="flex:1; padding:12px; border-radius:10px; border:none; background:var(--primary); color:white; font-weight:bold; cursor:pointer;">Buka Akses</button>
            <button onclick="closePassModal()" style="flex:1; padding:12px; border-radius:10px; border:none; background:#334155; color:white; cursor:pointer;">Batal</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzA1O20Jp4d3uOqygbZDbkjeePQWfiWp8rpV-7_Eyt3mpB2Qdm0Drc70wN0DovRygsE/exec";
    
    let db = [];
    let isAuthorized = false;
    let currentEmployeeIndex = null;
    let pendingUrl = ""; // Menyimpan URL yang akan dibuka setelah login berhasil

    const getVal = (obj, key) => {
        if (!obj) return "-";
        const foundKey = Object.keys(obj).find(k => k.trim().toLowerCase() === key.toLowerCase());
        return foundKey ? obj[foundKey] : "-";
    };

    async function loadData() {
        const statusEl = document.getElementById('status');
        try {
            const res = await fetch(SCRIPT_URL);
            db = await res.json();
            statusEl.innerText = "‚úÖ Terkoneksi";
            renderTable(db);
            updateStats(db);
        } catch (e) {
            statusEl.innerText = "‚ùå Gagal Terhubung";
        }
    }

    function checkDate(dateStr) {
        if (!dateStr || dateStr === "-" || dateStr === "") return { label: 'TIDAK ADA', cls: 'none' };
        const today = new Date(); today.setHours(0,0,0,0);
        const expDate = new Date(dateStr);
        if (isNaN(expDate.getTime())) return { label: 'FORMAT SALAH', cls: 'none' };
        return expDate >= today ? { label: 'AKTIF', cls: 'active' } : { label: 'EXPIRED', cls: 'expired' };
    }

    function renderTable(data) {
        const body = document.getElementById('tableBody');
        
        // 1. Logika Pemisahan Data
        // Mencari kata "Kepala" atau "Karu" (tidak peduli huruf besar/kecil)
        const daftarKepala = data.filter(p => {
            const jabatan = getVal(p, "Jabatan").toLowerCase();
            return jabatan.includes("kepala") || jabatan.includes("karu");
        });

        // Sisanya masuk ke kategori Pelaksana/Staf
        const daftarPelaksana = data.filter(p => {
            const jabatan = getVal(p, "Jabatan").toLowerCase();
            return !jabatan.includes("kepala") && !jabatan.includes("karu");
        });

        const createRow = (p) => {
            const index = db.indexOf(p);
            const strStat = checkDate(getVal(p, "Masa Berlaku STR"));
            const sipStat = checkDate(getVal(p, "Masa Berlaku SIP"));
            
            return `
                <tr>
                    <td>
                        <strong>${getVal(p, "Nama Pegawai")}</strong><br>
                        <small style="color:var(--text-muted)">NIP: ${getVal(p, "NIP / NIKRS")}</small>
                    </td>
                    <td>
                        <strong>${getVal(p, "Unit Kerja")}</strong><br>
                        <small style="color:var(--text-muted)">${getVal(p, "Jabatan")}</small><br>
                        <small style="color:var(--primary); font-weight:700;">‚è± MK: ${getVal(p, "Masa Kerja")}</small> 
                    </td>
                    <td><span class="badge ${strStat.cls}">${strStat.label}</span><br><small style="color:var(--text-muted)">${getVal(p, "Masa Berlaku STR")}</small></td>
                    <td><span class="badge ${sipStat.cls}">${sipStat.label}</span><br><small style="color:var(--text-muted)">${getVal(p, "Masa Berlaku SIP")}</small></td>
                    <td><button class="btn-view" onclick="openDetail(${index})">Detail Berkas</button></td>
                </tr>`;
        };

        let html = "";

        // Render Bagian Kepala Ruangan
        if (daftarKepala.length > 0) {
            html += `<tr style="background: rgba(129, 140, 248, 0.15); border-left: 4px solid var(--primary);">
                        <td colspan="5" style="color:var(--primary); font-weight:800; font-size:12px; padding: 10px 15px;">
                           ‚≠ê KELOMPOK JABATAN: KEPALA RUANGAN
                        </td>
                     </tr>`;
            html += daftarKepala.map(createRow).join('');
        }

        // Render Bagian Pelaksana
        if (daftarPelaksana.length > 0) {
            html += `<tr style="background: rgba(148, 163, 184, 0.1); border-left: 4px solid var(--text-muted);">
                        <td colspan="5" style="color:var(--text-muted); font-weight:800; font-size:12px; padding: 10px 15px;">
                           üë• KELOMPOK JABATAN: PELAKSANA / STAF
                        </td>
                     </tr>`;
            html += daftarPelaksana.map(createRow).join('');
        }

        body.innerHTML = html || `<tr><td colspan="5" style="text-align:center; padding:30px;">Data tidak ditemukan</td></tr>`;
    }

    function openDetail(i) {
        currentEmployeeIndex = i;
        const p = db[i];
        const content = `
            <h2 style="margin:0 0 5px 0">${getVal(p, "Nama Pegawai")}</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">${getVal(p, "Jabatan")}</p>
            
            <div style="background:#0f172a; padding:15px; border-radius:12px; font-size:12px; margin-bottom:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; border: 1px solid var(--border);">
                <div><small style="color:var(--text-muted)">Masa Kerja</small><br><strong>${getVal(p, "Masa Kerja")}</strong></div>
                <div><small style="color:var(--text-muted)">Gelar</small><br><strong>${getVal(p, "Gelar")}</strong></div>
            </div>

            <p style="font-size:11px; font-weight:800; color:var(--primary); margin-bottom:10px;">BERKAS DIGITAL ${isAuthorized ? 'üîì TERBUKA' : 'üîí TERKUNCI'}</p>
            ${renderLink(getVal(p, "Upload Scan Ijazah"), "Scan Ijazah")}
            ${renderLink(getVal(p, "Upload Scan STR"), "Scan STR")}
            ${renderLink(getVal(p, "Upload Scan SIP"), "Scan SIP")}
            ${renderLink(getVal(p, "Upload Sertifikat Pelatihan Utama"), "Sertifikat Pelatihan")}
            ${renderLink(getVal(p, "Surat Tugas Penempatan Unit"), "Surat Tugas")}
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="document.getElementById('modal').style.display='none'" style="flex:2; padding:14px; border:none; border-radius:10px; cursor:pointer; background:#334155; color:white; font-weight:700;">Tutup</button>
                <button onclick="resetAkses()" style="flex:1; padding:14px; border:1px solid var(--danger); border-radius:10px; cursor:pointer; background:transparent; color:var(--danger); font-weight:700; font-size:10px;">üîí RESET AKSES</button>
            </div>
        `;
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modal').style.display = 'flex';
    }

    // Tambahkan fungsi resetAkses ini di bagian bawah <script>
   function resetAkses() {
        isAuthorized = false;
        alert("Akses Dokumen Berhasil Dikunci Kembali üîí");
        if (currentEmployeeIndex !== null) {
            openDetail(currentEmployeeIndex); // Refresh tampilan agar ikon berubah jadi gembok
        }
    }

    function renderLink(url, label) {
        if (!url || url.length < 10) return "";
        return `<div class="doc-link" style="cursor:pointer" onclick="checkFileAccess('${url}')">
                    üìÑ ${label} <span>${isAuthorized ? 'üîì' : 'üîí'}</span>
                </div>`;
    }

    // FUNGSI MEMBUKA MODAL PASSWORD
    function checkFileAccess(url) {
        if (isAuthorized) { window.open(url, '_blank'); return; }
        pendingUrl = url;
        document.getElementById('passModal').style.display = 'flex';
        document.getElementById('adminPassInput').focus();
    }

    // FUNGSI SUBMIT PASSWORD
    function submitPassword() {
        const pass = document.getElementById('adminPassInput').value;
        if (pass === "admin123") {
            isAuthorized = true;
            document.getElementById('passModal').style.display = 'none';
            document.getElementById('adminPassInput').value = "";
            openDetail(currentEmployeeIndex); // Refresh ikon gembok
            window.open(pendingUrl, '_blank');
        } else {
            alert("Sandi Salah!");
            document.getElementById('adminPassInput').value = "";
        }
    }

    function closePassModal() {
        document.getElementById('passModal').style.display = 'none';
        document.getElementById('adminPassInput').value = "";
    }

    function updateStats(data) {
        document.getElementById('statTotal').innerText = data.length;
        document.getElementById('statStr').innerText = data.filter(p => checkDate(getVal(p, "Masa Berlaku STR")).label === 'AKTIF').length;
        document.getElementById('statSip').innerText = data.filter(p => checkDate(getVal(p, "Masa Berlaku SIP")).label === 'AKTIF').length;
    }

    function filterData() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const filtered = db.filter(p => getVal(p, "Nama Pegawai").toLowerCase().includes(val));
        renderTable(filtered);
    }

    window.onload = loadData;

    // Tambahan: Enter untuk submit password
    document.getElementById('adminPassInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') submitPassword();
    });
</script>
</body>
</html>